<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TKC自計化×自動化 効果試算ツール r4</title>
<style>
  :root { --bg:#f7f7fb; --panel:#ffffff; --ink:#1f2937; --sub:#6b7280; --brand:#578899; --ok:#16a34a; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;}
  .wrap{max-width:980px;margin:24px auto;padding:0 12px 88px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .h1{font-size:clamp(18px,4.6vw,28px);font-weight:800;color:var(--brand)}
  .badge{font-size:12px;background:#e6f3f7;color:#145b6b;border:1px solid #cfe7ee;padding:6px 10px;border-radius:999px}
  .card{background:var(--panel);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 18px rgba(16,50,94,.06);padding:16px;margin:12px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--sub);display:block;margin-bottom:6px}
  input[type="number"],select,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:15px}
  input:focus,select:focus,textarea:focus{outline:2px solid #cfe7ee;border-color:#9cc9d8}
  .row{display:grid;grid-template-columns:1.6fr .8fr .8fr;gap:8px;align-items:end}
  .unit{font-size:12px;color:#9ca3af}
  .mod{border:1px dashed #d4dde5;border-radius:14px;padding:12px;margin-top:10px;background:#fcfdff}
  .mod header{display:flex;gap:10px;align-items:center}
  .mod h3{margin:0;font-size:16px}
  .muted{color:#6b7280}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #e4e9ee;background:#fafcff;border-radius:999px;padding:4px 10px;font-size:12px}
  .btn{appearance:none;border:1px solid #cfd7df;background:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#2bb3df,#2598c9);border-color:#197da6;color:#fff}
  .btn.ghost{background:#f4f7fb}
  .btn.good{background:#10b981;border-color:#059669;color:#fff}
  .btn:active{transform:translateY(1px)}
  .toolbar{position:sticky;bottom:0;left:0;right:0;background:rgba(247,247,251,.94);backdrop-filter:saturate(120%) blur(8px);border-top:1px solid #e7ebf2;padding:8px 12px;display:flex;gap:8px;justify-content:center}
  .stat{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media(max-width:760px){.stat{grid-template-columns:1fr 1fr}}
  .stat .k{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px}
  .stat .k .v{font-size:22px;font-weight:800}
  .notice{background:#fff8e1;border:1px solid #f1d48c;color:#7a5d00;padding:10px;border-radius:10px}
</style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="h1">TKC方式｜自計化×自動化 効果試算ツール <span class="badge">r4</span></div>
      <div class="pill" id="tsNow">—</div>
    </header>

    <div class="card">
      <p class="muted" style="margin:0 0 8px">月次で各モジュールの件数・時間・削減率を入れると、<b>削減時間</b>→<b>人件費削減額</b>→<b>純効果</b>を即時計算します。数値は概算なので現場実測で上書きしてください。</p>
      <div class="grid">
        <div>
          <label>担当者の時給（社保込の実勢）</label>
          <input type="number" id="wage" value="2500" min="0" step="100" inputmode="numeric" />
        </div>
        <div>
          <label>表示単位</label>
          <select id="unit">
            <option value="month" selected>月次</option>
            <option value="year">年換算（×12）</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 証憑保存（スマホで経費） -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="exp-on" checked />
        <h3>証憑保存（スマホで経費）</h3>
        <span class="pill">撮影→OCR→自動起票</span>
      </header>
      <div class="grid">
        <div>
          <label>対象枚数/月</label>
          <input type="number" id="exp-n" value="400" min="0" step="10" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="exp-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1枚あたり（秒）</label>
          <input type="number" id="exp-base" value="90" min="0" step="5" inputmode="numeric" />
          <div class="unit">例：剥がし・貼付・入力・台帳</div>
        </div>
        <div>
          <label>導入後：1枚あたり（秒）</label>
          <input type="number" id="exp-after" value="30" min="0" step="1" inputmode="numeric" />
          <div class="unit">例：撮影→自動読取→確認</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="exp-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 銀行・信販データ受信 -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="bank-on" checked />
        <h3>銀行・信販データ受信</h3>
        <span class="pill">明細自動取込＋自動仕訳</span>
      </header>
      <div class="grid">
        <div>
          <label>取引件数/月</label>
          <input type="number" id="bank-n" value="800" min="0" step="10" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="bank-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1件あたり（秒）</label>
          <input type="number" id="bank-base" value="30" min="0" step="5" inputmode="numeric" />
          <div class="unit">手入力・照合・CSV整形</div>
        </div>
        <div>
          <label>導入後：1件あたり（秒）</label>
          <input type="number" id="bank-after" value="8" min="0" step="1" inputmode="numeric" />
          <div class="unit">自動取込＋学習ルール</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="bank-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 給与計算 -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="pay-on" checked />
        <h3>給与計算</h3>
        <span class="pill">勤怠連携・控除計算・Web明細</span>
      </header>
      <div class="grid">
        <div>
          <label>従業員数</label>
          <input type="number" id="pay-n" value="50" min="0" step="1" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="pay-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1人あたり（分）</label>
          <input type="number" id="pay-base" value="20" min="0" step="1" inputmode="numeric" />
          <div class="unit">勤怠・控除・社保・明細配布</div>
        </div>
        <div>
          <label>導入後：1人あたり（分）</label>
          <input type="number" id="pay-after" value="8" min="0" step="1" inputmode="numeric" />
          <div class="unit">自動連携＋一括計算</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="pay-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 販売管理（受注・請求） -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="sales-on" checked />
        <h3>販売管理（受注・請求）</h3>
        <span class="pill">受注→売上→請求→入金消込</span>
      </header>
      <div class="grid">
        <div>
          <label>件数/月（受注・請求の合計）</label>
          <input type="number" id="sales-n" value="300" min="0" step="10" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="sales-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1件あたり（分）</label>
          <input type="number" id="sales-base" value="6" min="0" step="1" inputmode="numeric" />
          <div class="unit">受注入力・売上転記・請求発行</div>
        </div>
        <div>
          <label>導入後：1件あたり（分）</label>
          <input type="number" id="sales-after" value="2" min="0" step="1" inputmode="numeric" />
          <div class="unit">自動連携・一括処理</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="sales-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 結果表示 -->
    <div class="card">
      <div class="stat" aria-live="polite">
        <div class="k"><div class="label muted">合計削減時間</div><div class="v" id="out-hours">—</div><div class="muted" id="out-hours-note">/月</div></div>
        <div class="k"><div class="label muted">人件費削減額</div><div class="v" id="out-laborsave">—</div><div class="muted" id="out-laborsave-note"></div></div>
        <div class="k"><div class="label muted">月額費用合計</div><div class="v" id="out-fee">—</div><div class="muted">（4モジュール）</div></div>
        <div class="k"><div class="label muted">純効果（削減−費用）</div><div class="v" id="out-net">—</div><div class="muted" id="out-net-note"></div></div>
      </div>
      <div class="notice" style="margin-top:10px">注意：削減時間は0未満にならないよう自動で0に丸めています。%を入れた場合は%を優先します。</div>
    </div>

    <div class="card">
      <details open>
        <summary>出力テキスト</summary>
        <textarea id="out-text" style="width:100%;min-height:110px"></textarea>
      </details>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="do-calc" type="button">効果を計算</button>
      <button class="btn" id="do-copy" type="button">コピー</button>
      <button class="btn ghost" id="do-reset" type="button">リセット</button>
      <button class="btn good" id="do-print" type="button">印刷</button>
    </div>

    <footer class="muted" style="margin-top:10px">© 松本会計｜試算アプリ r4（2025-08-25）。</footer>
  </div>

<script>
(()=>{
  'use strict';
  const $ = id => document.getElementById(id);
  const N = v => { const n = parseFloat(v); return Number.isFinite(n) ? n : 0; };
  const clamp = (x,min,max)=> Math.min(Math.max(x,min),max);
  const fmtYen = n => Number.isFinite(n) ? '¥'+Math.round(n).toLocaleString() : '—';
  const fmtH = h => Number.isFinite(h) ? (h.toFixed(1)+' 時間') : '—';
  let rafId = null;

  function secByRate(baseSec, rateStr){
    if(rateStr===''||rateStr===null||rateStr===undefined) return null;
    const r = clamp(N(rateStr),0,100)/100; return baseSec*(1-r);
  }
  function savedHoursBySec(n, baseSec, afterSec){
    const saved = Math.max((baseSec-afterSec)*n, 0);
    return saved/3600;
  }
  function savedHoursByMin(n, baseMin, afterMin){
    const saved = Math.max((baseMin-afterMin)*n, 0);
    return saved/60;
  }

  function mExpense(){
    if(!$('exp-on').checked) return {h:0, fee:N($('exp-fee').value)};
    const n=N($('exp-n').value), base=N($('exp-base').value), rate=$('exp-rate').value, after0=N($('exp-after').value);
    const after = secByRate(base, rate) ?? after0; 
    return {h: savedHoursBySec(n, base, after), fee:N($('exp-fee').value)};
  }
  function mBank(){
    if(!$('bank-on').checked) return {h:0, fee:N($('bank-fee').value)};
    const n=N($('bank-n').value), base=N($('bank-base').value), rate=$('bank-rate').value, after0=N($('bank-after').value);
    const after = secByRate(base, rate) ?? after0;
    return {h: savedHoursBySec(n, base, after), fee:N($('bank-fee').value)};
  }
  function mPayroll(){
    if(!$('pay-on').checked) return {h:0, fee:N($('pay-fee').value)};
    const n=N($('pay-n').value), base=N($('pay-base').value), r=$('pay-rate').value, after0=N($('pay-after').value);
    const after = (r===''||r===null)? after0 : base*(1-clamp(N(r),0,100)/100);
    return {h: savedHoursByMin(n, base, after), fee:N($('pay-fee').value)};
  }
  function mSales(){
    if(!$('sales-on').checked) return {h:0, fee:N($('sales-fee').value)};
    const n=N($('sales-n').value), base=N($('sales-base').value), r=$('sales-rate').value, after0=N($('sales-after').value);
    const after = (r===''||r===null)? after0 : base*(1-clamp(N(r),0,100)/100);
    return {h: savedHoursByMin(n, base, after), fee:N($('sales-fee').value)};
  }

  function recalc(){
    const unit = $('unit').value; const wage=N($('wage').value);
    const mods=[mExpense(),mBank(),mPayroll(),mSales()];
    let hours = mods.reduce((s,m)=>s+m.h,0);
    let fees = mods.reduce((s,m)=>s+m.fee,0);
    let note = '/月';
    if(unit==='year'){ hours*=12; fees*=12; note='/年'; }
    const laborSave = hours*wage; const net=laborSave-fees;

    $('out-hours').textContent=fmtH(hours);
    $('out-hours-note').textContent=note;
    $('out-laborsave').textContent=fmtYen(laborSave);
    $('out-laborsave-note').textContent=note;
    $('out-fee').textContent=fmtYen(fees);
    $('out-net').textContent=fmtYen(net);
    $('out-net-note').textContent= net>=0?'（導入効果プラス）':'（要見直し）';

    const detail = (name,m)=>`${name}: 時間${m.h.toFixed(2)}h, 費用${fmtYen(m.fee)}`;
    const [e,b,p,s]=[mExpense(),mBank(),mPayroll(),mSales()];
    const lines=[`【効果サマリ${unit==='year'?'（年換算）':'（月次）'}】削減時間: ${hours.toFixed(1)}時間 / 人件費削減額: ${fmtYen(laborSave)} / 費用合計: ${fmtYen(fees)} / 純効果: ${fmtYen(net)}`,
                 [detail('証憑保存',e),detail('銀行・信販データ受信',b),detail('給与計算',p),detail('販売管理',s)].join(' / '),
                 `前提：時給 ${fmtYen(wage)}、表示単位=${unit==='year'?'年':'月'}。`];
    $('out-text').value=lines.join('\n');
  }

  function schedule(){ if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(recalc); }

  function bindOnce(el, ev, handler){
    if(!el) return; if(el.dataset.bound==='1') return; el.addEventListener(ev, handler); el.dataset.bound='1';
  }
  function bind(){
    const app=$('app');
    if(app && app.dataset.bound!=='1'){
      app.addEventListener('input', schedule, {passive:true});
      app.addEventListener('change', schedule, {passive:true});
      app.dataset.bound='1';
    }
    bindOnce($('do-calc'),'click', recalc);
    bindOnce($('do-print'),'click', ()=>window.print());
    bindOnce($('do-reset'),'click', ()=>location.reload());
    bindOnce($('do-copy'),'click', ()=>{
      try{ const t=$('out-text'); t.select(); document.execCommand('copy'); }catch(_){}
    });
  }

  function init(){
    bind();
    recalc();
    const ts=$('tsNow'); if(ts) ts.textContent=new Intl.DateTimeFormat('ja-JP',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
  }

  // DOM準備の有無に依存しない初期化（キャンバス対策）
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else {
    // すでに読み込み済みの場合でも確実に初期化
    setTimeout(init, 0);
  }
  // 念のための再バインド（埋め込み環境での遅延対策）
  setTimeout(bind, 300);
})();
</script>
</body>
</html><!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TKC自計化×自動化 効果試算ツール r4</title>
<style>
  :root { --bg:#f7f7fb; --panel:#ffffff; --ink:#1f2937; --sub:#6b7280; --brand:#578899; --ok:#16a34a; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;}
  .wrap{max-width:980px;margin:24px auto;padding:0 12px 88px;}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .h1{font-size:clamp(18px,4.6vw,28px);font-weight:800;color:var(--brand)}
  .badge{font-size:12px;background:#e6f3f7;color:#145b6b;border:1px solid #cfe7ee;padding:6px 10px;border-radius:999px}
  .card{background:var(--panel);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 6px 18px rgba(16,50,94,.06);padding:16px;margin:12px 0}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
  label{font-size:13px;color:var(--sub);display:block;margin-bottom:6px}
  input[type="number"],select,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:15px}
  input:focus,select:focus,textarea:focus{outline:2px solid #cfe7ee;border-color:#9cc9d8}
  .row{display:grid;grid-template-columns:1.6fr .8fr .8fr;gap:8px;align-items:end}
  .unit{font-size:12px;color:#9ca3af}
  .mod{border:1px dashed #d4dde5;border-radius:14px;padding:12px;margin-top:10px;background:#fcfdff}
  .mod header{display:flex;gap:10px;align-items:center}
  .mod h3{margin:0;font-size:16px}
  .muted{color:#6b7280}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid #e4e9ee;background:#fafcff;border-radius:999px;padding:4px 10px;font-size:12px}
  .btn{appearance:none;border:1px solid #cfd7df;background:#fff;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#2bb3df,#2598c9);border-color:#197da6;color:#fff}
  .btn.ghost{background:#f4f7fb}
  .btn.good{background:#10b981;border-color:#059669;color:#fff}
  .btn:active{transform:translateY(1px)}
  .toolbar{position:sticky;bottom:0;left:0;right:0;background:rgba(247,247,251,.94);backdrop-filter:saturate(120%) blur(8px);border-top:1px solid #e7ebf2;padding:8px 12px;display:flex;gap:8px;justify-content:center}
  .stat{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  @media(max-width:760px){.stat{grid-template-columns:1fr 1fr}}
  .stat .k{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px}
  .stat .k .v{font-size:22px;font-weight:800}
  .notice{background:#fff8e1;border:1px solid #f1d48c;color:#7a5d00;padding:10px;border-radius:10px}
</style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <div class="h1">TKC方式｜自計化×自動化 効果試算ツール <span class="badge">r4</span></div>
      <div class="pill" id="tsNow">—</div>
    </header>

    <div class="card">
      <p class="muted" style="margin:0 0 8px">月次で各モジュールの件数・時間・削減率を入れると、<b>削減時間</b>→<b>人件費削減額</b>→<b>純効果</b>を即時計算します。数値は概算なので現場実測で上書きしてください。</p>
      <div class="grid">
        <div>
          <label>担当者の時給（社保込の実勢）</label>
          <input type="number" id="wage" value="2500" min="0" step="100" inputmode="numeric" />
        </div>
        <div>
          <label>表示単位</label>
          <select id="unit">
            <option value="month" selected>月次</option>
            <option value="year">年換算（×12）</option>
          </select>
        </div>
      </div>
    </div>

    <!-- 証憑保存（スマホで経費） -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="exp-on" checked />
        <h3>証憑保存（スマホで経費）</h3>
        <span class="pill">撮影→OCR→自動起票</span>
      </header>
      <div class="grid">
        <div>
          <label>対象枚数/月</label>
          <input type="number" id="exp-n" value="400" min="0" step="10" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="exp-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1枚あたり（秒）</label>
          <input type="number" id="exp-base" value="90" min="0" step="5" inputmode="numeric" />
          <div class="unit">例：剥がし・貼付・入力・台帳</div>
        </div>
        <div>
          <label>導入後：1枚あたり（秒）</label>
          <input type="number" id="exp-after" value="30" min="0" step="1" inputmode="numeric" />
          <div class="unit">例：撮影→自動読取→確認</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="exp-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 銀行・信販データ受信 -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="bank-on" checked />
        <h3>銀行・信販データ受信</h3>
        <span class="pill">明細自動取込＋自動仕訳</span>
      </header>
      <div class="grid">
        <div>
          <label>取引件数/月</label>
          <input type="number" id="bank-n" value="800" min="0" step="10" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="bank-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1件あたり（秒）</label>
          <input type="number" id="bank-base" value="30" min="0" step="5" inputmode="numeric" />
          <div class="unit">手入力・照合・CSV整形</div>
        </div>
        <div>
          <label>導入後：1件あたり（秒）</label>
          <input type="number" id="bank-after" value="8" min="0" step="1" inputmode="numeric" />
          <div class="unit">自動取込＋学習ルール</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="bank-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 給与計算 -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="pay-on" checked />
        <h3>給与計算</h3>
        <span class="pill">勤怠連携・控除計算・Web明細</span>
      </header>
      <div class="grid">
        <div>
          <label>従業員数</label>
          <input type="number" id="pay-n" value="50" min="0" step="1" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="pay-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1人あたり（分）</label>
          <input type="number" id="pay-base" value="20" min="0" step="1" inputmode="numeric" />
          <div class="unit">勤怠・控除・社保・明細配布</div>
        </div>
        <div>
          <label>導入後：1人あたり（分）</label>
          <input type="number" id="pay-after" value="8" min="0" step="1" inputmode="numeric" />
          <div class="unit">自動連携＋一括計算</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="pay-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 販売管理（受注・請求） -->
    <div class="card mod">
      <header>
        <input type="checkbox" id="sales-on" checked />
        <h3>販売管理（受注・請求）</h3>
        <span class="pill">受注→売上→請求→入金消込</span>
      </header>
      <div class="grid">
        <div>
          <label>件数/月（受注・請求の合計）</label>
          <input type="number" id="sales-n" value="300" min="0" step="10" inputmode="numeric" />
        </div>
        <div>
          <label>月額費用（円）</label>
          <input type="number" id="sales-fee" value="0" min="0" step="100" inputmode="numeric" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>現行：1件あたり（分）</label>
          <input type="number" id="sales-base" value="6" min="0" step="1" inputmode="numeric" />
          <div class="unit">受注入力・売上転記・請求発行</div>
        </div>
        <div>
          <label>導入後：1件あたり（分）</label>
          <input type="number" id="sales-after" value="2" min="0" step="1" inputmode="numeric" />
          <div class="unit">自動連携・一括処理</div>
        </div>
        <div>
          <label>または 削減率（%）</label>
          <input type="number" id="sales-rate" value="" min="0" max="100" step="1" inputmode="numeric" placeholder="未指定" />
        </div>
      </div>
    </div>

    <!-- 結果表示 -->
    <div class="card">
      <div class="stat" aria-live="polite">
        <div class="k"><div class="label muted">合計削減時間</div><div class="v" id="out-hours">—</div><div class="muted" id="out-hours-note">/月</div></div>
        <div class="k"><div class="label muted">人件費削減額</div><div class="v" id="out-laborsave">—</div><div class="muted" id="out-laborsave-note"></div></div>
        <div class="k"><div class="label muted">月額費用合計</div><div class="v" id="out-fee">—</div><div class="muted">（4モジュール）</div></div>
        <div class="k"><div class="label muted">純効果（削減−費用）</div><div class="v" id="out-net">—</div><div class="muted" id="out-net-note"></div></div>
      </div>
      <div class="notice" style="margin-top:10px">注意：削減時間は0未満にならないよう自動で0に丸めています。%を入れた場合は%を優先します。</div>
    </div>

    <div class="card">
      <details open>
        <summary>出力テキスト</summary>
        <textarea id="out-text" style="width:100%;min-height:110px"></textarea>
      </details>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="do-calc" type="button">効果を計算</button>
      <button class="btn" id="do-copy" type="button">コピー</button>
      <button class="btn ghost" id="do-reset" type="button">リセット</button>
      <button class="btn good" id="do-print" type="button">印刷</button>
    </div>

    <footer class="muted" style="margin-top:10px">© 松本会計｜試算アプリ r4（2025-08-25）。</footer>
  </div>

<script>
(()=>{
  'use strict';
  const $ = id => document.getElementById(id);
  const N = v => { const n = parseFloat(v); return Number.isFinite(n) ? n : 0; };
  const clamp = (x,min,max)=> Math.min(Math.max(x,min),max);
  const fmtYen = n => Number.isFinite(n) ? '¥'+Math.round(n).toLocaleString() : '—';
  const fmtH = h => Number.isFinite(h) ? (h.toFixed(1)+' 時間') : '—';
  let rafId = null;

  function secByRate(baseSec, rateStr){
    if(rateStr===''||rateStr===null||rateStr===undefined) return null;
    const r = clamp(N(rateStr),0,100)/100; return baseSec*(1-r);
  }
  function savedHoursBySec(n, baseSec, afterSec){
    const saved = Math.max((baseSec-afterSec)*n, 0);
    return saved/3600;
  }
  function savedHoursByMin(n, baseMin, afterMin){
    const saved = Math.max((baseMin-afterMin)*n, 0);
    return saved/60;
  }

  function mExpense(){
    if(!$('exp-on').checked) return {h:0, fee:N($('exp-fee').value)};
    const n=N($('exp-n').value), base=N($('exp-base').value), rate=$('exp-rate').value, after0=N($('exp-after').value);
    const after = secByRate(base, rate) ?? after0; 
    return {h: savedHoursBySec(n, base, after), fee:N($('exp-fee').value)};
  }
  function mBank(){
    if(!$('bank-on').checked) return {h:0, fee:N($('bank-fee').value)};
    const n=N($('bank-n').value), base=N($('bank-base').value), rate=$('bank-rate').value, after0=N($('bank-after').value);
    const after = secByRate(base, rate) ?? after0;
    return {h: savedHoursBySec(n, base, after), fee:N($('bank-fee').value)};
  }
  function mPayroll(){
    if(!$('pay-on').checked) return {h:0, fee:N($('pay-fee').value)};
    const n=N($('pay-n').value), base=N($('pay-base').value), r=$('pay-rate').value, after0=N($('pay-after').value);
    const after = (r===''||r===null)? after0 : base*(1-clamp(N(r),0,100)/100);
    return {h: savedHoursByMin(n, base, after), fee:N($('pay-fee').value)};
  }
  function mSales(){
    if(!$('sales-on').checked) return {h:0, fee:N($('sales-fee').value)};
    const n=N($('sales-n').value), base=N($('sales-base').value), r=$('sales-rate').value, after0=N($('sales-after').value);
    const after = (r===''||r===null)? after0 : base*(1-clamp(N(r),0,100)/100);
    return {h: savedHoursByMin(n, base, after), fee:N($('sales-fee').value)};
  }

  function recalc(){
    const unit = $('unit').value; const wage=N($('wage').value);
    const mods=[mExpense(),mBank(),mPayroll(),mSales()];
    let hours = mods.reduce((s,m)=>s+m.h,0);
    let fees = mods.reduce((s,m)=>s+m.fee,0);
    let note = '/月';
    if(unit==='year'){ hours*=12; fees*=12; note='/年'; }
    const laborSave = hours*wage; const net=laborSave-fees;

    $('out-hours').textContent=fmtH(hours);
    $('out-hours-note').textContent=note;
    $('out-laborsave').textContent=fmtYen(laborSave);
    $('out-laborsave-note').textContent=note;
    $('out-fee').textContent=fmtYen(fees);
    $('out-net').textContent=fmtYen(net);
    $('out-net-note').textContent= net>=0?'（導入効果プラス）':'（要見直し）';

    const detail = (name,m)=>`${name}: 時間${m.h.toFixed(2)}h, 費用${fmtYen(m.fee)}`;
    const [e,b,p,s]=[mExpense(),mBank(),mPayroll(),mSales()];
    const lines=[`【効果サマリ${unit==='year'?'（年換算）':'（月次）'}】削減時間: ${hours.toFixed(1)}時間 / 人件費削減額: ${fmtYen(laborSave)} / 費用合計: ${fmtYen(fees)} / 純効果: ${fmtYen(net)}`,
                 [detail('証憑保存',e),detail('銀行・信販データ受信',b),detail('給与計算',p),detail('販売管理',s)].join(' / '),
                 `前提：時給 ${fmtYen(wage)}、表示単位=${unit==='year'?'年':'月'}。`];
    $('out-text').value=lines.join('\n');
  }

  function schedule(){ if(rafId) cancelAnimationFrame(rafId); rafId=requestAnimationFrame(recalc); }

  function bindOnce(el, ev, handler){
    if(!el) return; if(el.dataset.bound==='1') return; el.addEventListener(ev, handler); el.dataset.bound='1';
  }
  function bind(){
    const app=$('app');
    if(app && app.dataset.bound!=='1'){
      app.addEventListener('input', schedule, {passive:true});
      app.addEventListener('change', schedule, {passive:true});
      app.dataset.bound='1';
    }
    bindOnce($('do-calc'),'click', recalc);
    bindOnce($('do-print'),'click', ()=>window.print());
    bindOnce($('do-reset'),'click', ()=>location.reload());
    bindOnce($('do-copy'),'click', ()=>{
      try{ const t=$('out-text'); t.select(); document.execCommand('copy'); }catch(_){}
    });
  }

  function init(){
    bind();
    recalc();
    const ts=$('tsNow'); if(ts) ts.textContent=new Intl.DateTimeFormat('ja-JP',{dateStyle:'medium',timeStyle:'short'}).format(new Date());
  }

  // DOM準備の有無に依存しない初期化（キャンバス対策）
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', init, {once:true});
  } else {
    // すでに読み込み済みの場合でも確実に初期化
    setTimeout(init, 0);
  }
  // 念のための再バインド（埋め込み環境での遅延対策）
  setTimeout(bind, 300);
})();
</script>
</body>
</html>