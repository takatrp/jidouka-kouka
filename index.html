import React, { useMemo, useState, useEffect } from "react";

/**
 * TKC方式 | 自計化×自動化 効果試算アプリ React版（r10）
 * - 入力即時計算（自動計算）
 * - 記帳代行との比較モード（記帳代行報酬の入力）
 * - コピー / 印刷 / CSV出力 ボタン実装
 * - 「その他」は月間仕訳総数との差分で自動調整（合計は常に一致）
 */

function yen(n) {
  if (isNaN(n)) return "¥0";
  try {
    return n.toLocaleString("ja-JP", {
      style: "currency",
      currency: "JPY",
      maximumFractionDigits: 0,
    });
  } catch {
    return `¥${Math.round(n)}`;
  }
}

function csvEscape(v) {
  if (v === undefined || v === null) return "";
  const s = String(v).replace(/"/g, '""');
  return /[",

]/.test(s) ? `"${s}"` : s;
}

export default function App() {
  // ---- グローバル前提 ----
  const [fxFee, setFxFee] = useState(0); // 円/月（FXシリーズ基本料金）
  const [wage, setWage] = useState(0); // 円/時（法定福利費・賞与按分・間接含む実効時給）
  const [totalJournals, setTotalJournals] = useState(320); // 月間仕訳総数
  const [osFee, setOsFee] = useState(0); // 記帳代行報酬 円/月（比較用）

  // ---- 機能別（件数と1件あたり時間[分]）----
  const [nReceipts, setNReceipts] = useState(30);
  const [tReceiptsBefore, setTReceiptsBefore] = useState(3);
  const [tReceiptsAfter, setTReceiptsAfter] = useState(1);

  const [nBank, setNBank] = useState(260);
  const [tBankBefore, setTBankBefore] = useState(2);
  const [tBankAfter, setTBankAfter] = useState(0.5);

  const [nPayroll, setNPayroll] = useState(10);
  const [tPayrollBefore, setTPayrollBefore] = useState(8);
  const [tPayrollAfter, setTPayrollAfter] = useState(3);

  const [nSales, setNSales] = useState(12);
  const [tSalesBefore, setTSalesBefore] = useState(10);
  const [tSalesAfter, setTSalesAfter] = useState(4);

  const [tOtherBefore, setTOtherBefore] = useState(1.5);
  const [tOtherAfter, setTOtherAfter] = useState(1.5);

  // その他件数は自動調整：合計が必ず totalJournals に一致
  const nOther = useMemo(
    () => totalJournals - (nReceipts + nBank + nPayroll + nSales),
    [totalJournals, nReceipts, nBank, nPayroll, nSales]
  );

  // 機能配列を算出
  const mods = useMemo(() => {
    const safeCnt = (n) => Math.max(0, n); // 負カウントは時間計算に使わない
    const mk = (label, n, tb, ta) => {
      const cnt = safeCnt(n);
      const hB = (tb * cnt) / 60; // before hours
      const hA = (ta * cnt) / 60; // after hours
      const hS = Math.max(0, hB - hA); // saved
      const cB = hB * wage;
      const cA = hA * wage;
      return { label, cnt, tb, ta, hB, hA, hS, cB, cA };
    };
    return [
      mk("証憑保存（スマホで経費）", nReceipts, tReceiptsBefore, tReceiptsAfter),
      mk("銀行信販データ受信機能", nBank, tBankBefore, tBankAfter),
      mk("給与計算機能（仕訳含む）", nPayroll, tPayrollBefore, tPayrollAfter),
      mk("販売管理機能（売上計上・請求）", nSales, tSalesBefore, tSalesAfter),
      mk("その他", nOther, tOtherBefore, tOtherAfter),
    ];
  }, [
    nReceipts,
    tReceiptsBefore,
    tReceiptsAfter,
    nBank,
    tBankBefore,
    tBankAfter,
    nPayroll,
    tPayrollBefore,
    tPayrollAfter,
    nSales,
    tSalesBefore,
    tSalesAfter,
    nOther,
    tOtherBefore,
    tOtherAfter,
    wage,
  ]);

  // 集計
  const result = useMemo(() => {
    const hBefore = mods.reduce((s, m) => s + m.hB, 0);
    const hAfter = mods.reduce((s, m) => s + m.hA, 0);
    const hSaved = Math.max(0, hBefore - hAfter);

    const costBefore = hBefore * wage;
    const costAfter = hAfter * wage;
    const monthlySaving = costBefore - costAfter; // = hSaved * wage

    const net = monthlySaving - fxFee; // 自計化×自動化によるネット効果（月）
    const netYear = net * 12;

    const selfTotal = costAfter + fxFee; // 自計化×自動化トータルコスト（月）
    const delta = osFee - selfTotal; // 記帳代行 − 自計化×自動化（＋なら代行の方が高い）
    const deltaYear = delta * 12;

    return {
      hBefore,
      hAfter,
      hSaved,
      costBefore,
      costAfter,
      monthlySaving,
      net,
      netYear,
      selfTotal,
      delta,
      deltaYear,
    };
  }, [mods, wage, fxFee, osFee]);

  // トースト表示（1.6秒で消える）
  const [toast, setToast] = useState("");
  useEffect(() => {
    if (!toast) return;
    const t = setTimeout(() => setToast(""), 1600);
    return () => clearTimeout(t);
  }, [toast]);

  // クリップボードコピー
  async function copySummary() {
    const lines = [];
    lines.push("【自計化×自動化 効果試算サマリー】");
    lines.push(
      `人件費単価: ${wage} 円/時, FX基本料金: ${fxFee} 円/月, 記帳代行報酬: ${osFee} 円/月`
    );
    lines.push("— 機能別（件数/分/分/削減h）");
    mods.forEach((m) =>
      lines.push(
        `${m.label}: ${m.cnt}件 / ${m.tb}分 / ${m.ta}分 / ${m.hS.toFixed(2)}h`
      )
    );
    lines.push(
      `総手作業時間: ${result.hBefore.toFixed(2)}h, 自動化後時間: ${result.hAfter.toFixed(2)}h, 時間短縮: ${result.hSaved.toFixed(2)}h`
    );
    lines.push(
      `手作業コスト: ${Math.round(result.costBefore)} 円, 自動化後コスト: ${Math.round(
        result.costAfter
      )} 円, 削減額: ${Math.round(result.monthlySaving)} 円`
    );
    lines.push(
      `ネット効果（月）: ${Math.round(result.net)} 円 / 年: ${Math.round(
        result.netYear
      )} 円`
    );
    lines.push(
      `自計化×自動化トータルコスト（月）: ${Math.round(result.selfTotal)} 円`
    );
    lines.push(
      `記帳代行比較: 差額（月）= ${Math.round(
        result.delta
      )} 円（記帳代行 − 自計化×自動化） / 年 = ${Math.round(result.deltaYear)} 円`
    );

    const text = lines.join("
");
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
      }
      setToast("コピーしました");
    } catch {
      setToast("コピーに失敗しました");
    }
  }

  // CSV出力
  function exportCSV() {
    const rows = [];
    rows.push([
      "項目",
      "件数",
      "手作業(分/件)",
      "自動化後(分/件)",
      "手作業時間(h)",
      "自動化後時間(h)",
      "削減時間(h)",
      "手作業コスト(円)",
      "自動化後コスト(円)",
    ]);
    mods.forEach((m) =>
      rows.push([
        m.label,
        m.cnt,
        m.tb,
        m.ta,
        m.hB.toFixed(2),
        m.hA.toFixed(2),
        m.hS.toFixed(2),
        Math.round(m.cB),
        Math.round(m.cA),
      ])
    );
    rows.push([]);
    rows.push(["人件費単価(円/時)", wage]);
    rows.push(["FX基本料金(円/月)", fxFee]);
    rows.push(["記帳代行報酬(円/月)", osFee]);
    rows.push(["総手作業時間(h)", result.hBefore.toFixed(2)]);
    rows.push(["総自動化後時間(h)", result.hAfter.toFixed(2)]);
    rows.push(["時間短縮(h)", result.hSaved.toFixed(2)]);
    rows.push(["手作業コスト(円/月)", Math.round(result.costBefore)]);
    rows.push(["自動化後コスト(円/月)", Math.round(result.costAfter)]);
    rows.push(["削減額(円/月)", Math.round(result.monthlySaving)]);
    rows.push(["ネット効果(円/月)", Math.round(result.net)]);
    rows.push(["ネット効果(円/年)", Math.round(result.netYear)]);
    rows.push(["自計化×自動化トータルコスト(円/月)", Math.round(result.selfTotal)]);
    rows.push([
      "差額=記帳代行−自計化×自動化(円/月)",
      Math.round(result.delta),
    ]);
    rows.push(["差額(円/年)", Math.round(result.deltaYear)]);

    const csv = rows
      .map((r) => r.map(csvEscape).join(","))
      .join("
");
    try {
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      const now = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      a.href = URL.createObjectURL(blob);
      a.download = `tkc_effect_${now.getFullYear()}${pad(
        now.getMonth() + 1
      )}${pad(now.getDate())}_${pad(now.getHours())}${pad(
        now.getMinutes()
      )}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setToast("CSVを作成しました");
    } catch {
      const w = window.open("", "_blank", "noopener");
      if (w) {
        w.document.write(
          "<pre>" +
            csv.replace(/[&<>]/g, (s) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;" }[s])) +
            "</pre>"
        );
        setToast("CSVを新規タブに表示しました");
      } else {
        setToast("CSV出力に失敗しました");
      }
    }
  }

  // 印刷
  function printPage() {
    try {
      window.print();
      setToast("印刷ダイアログを開きます");
    } catch {
      setToast("印刷がブロックされました");
    }
  }

  // リセット
  function resetAll() {
    setFxFee(0);
    setWage(0);
    setTotalJournals(320);
    setOsFee(0);

    setNReceipts(30);
    setTReceiptsBefore(3);
    setTReceiptsAfter(1);

    setNBank(260);
    setTBankBefore(2);
    setTBankAfter(0.5);

    setNPayroll(10);
    setTPayrollBefore(8);
    setTPayrollAfter(3);

    setNSales(12);
    setTSalesBefore(10);
    setTSalesAfter(4);

    setTOtherBefore(1.5);
    setTOtherAfter(1.5);

    setToast("初期値にリセットしました");
  }

  const sumFour = nReceipts + nBank + nPayroll + nSales;

  return (
    <div className="p-4 md:p-6 max-w-5xl mx-auto text-slate-800">
      <h1 className="text-2xl md:text-3xl font-bold mb-1">自計化×自動化の効果試算（TKC方式）</h1>
      <p className="text-slate-500 text-sm mb-4">
        各機能の合計と月間仕訳数の差は<strong>「その他」</strong>として自動調整され、合計は常に総数と一致します。
      </p>

      {/* 前提 */}
      <div className="bg-white rounded-2xl shadow p-4 mb-4">
        <div className="grid md:grid-cols-4 gap-3">
          <Field label="FXシリーズ基本料金（月額・円)">
            <input
              type="number"
              value={fxFee}
              onChange={(e) => setFxFee(Number(e.target.value || 0))}
              className="w-full border rounded-lg p-2"
            />
          </Field>
          <Field label="人件費単価（円/時・社保等込み)">
            <input
              type="number"
              value={wage}
              onChange={(e) => setWage(Number(e.target.value || 0))}
              className="w-full border rounded-lg p-2"
            />
          </Field>
          <Field label="月間仕訳数（総数)">
            <input
              type="number"
              value={totalJournals}
              onChange={(e) => setTotalJournals(Number(e.target.value || 0))}
              className="w-full border rounded-lg p-2"
            />
          </Field>
          <Field label="記帳代行報酬（比較用・月額・円)">
            <input
              type="number"
              value={osFee}
              onChange={(e) => setOsFee(Number(e.target.value || 0))}
              className="w-full border rounded-lg p-2"
            />
          </Field>
        </div>
        <p className="text-xs text-slate-400 mt-2">※ 時間は社内の実測値で置き換えてください。</p>
      </div>

      {/* 機能別 */}
      <div className="bg-white rounded-2xl shadow p-4 mb-4">
        <div className="grid grid-cols-12 gap-2 font-semibold text-slate-500 text-sm border-b pb-2">
          <div className="col-span-4">機能</div>
          <div className="col-span-2">件数（/月）</div>
          <div className="col-span-3">1件あたり 手作業（分）</div>
          <div className="col-span-3">1件あたり 自動化後（分）</div>
        </div>

        <Row
          label="証憑保存（スマホで経費）"
          n={nReceipts}
          setN={setNReceipts}
          tb={tReceiptsBefore}
          setTb={setTReceiptsBefore}
          ta={tReceiptsAfter}
          setTa={setTReceiptsAfter}
        />
        <Row
          label="銀行信販データ受信機能"
          n={nBank}
          setN={setNBank}
          tb={tBankBefore}
          setTb={setTBankBefore}
          ta={tBankAfter}
          setTa={setTBankAfter}
        />
        <Row
          label="給与計算機能（仕訳含む）"
          n={nPayroll}
          setN={setNPayroll}
          tb={tPayrollBefore}
          setTb={setTPayrollBefore}
          ta={tPayrollAfter}
          setTa={setTPayrollAfter}
        />
        <Row
          label="販売管理機能（売上計上・請求）"
          n={nSales}
          setN={setNSales}
          tb={tSalesBefore}
          setTb={setTSalesBefore}
          ta={tSalesAfter}
          setTa={setTSalesAfter}
        />

        <div className="grid grid-cols-12 gap-2 items-center border-t pt-2 mt-2">
          <div className="col-span-4 text-slate-700">その他（自動調整）</div>
          <div className="col-span-2">
            <input
              type="number"
              readOnly
              value={nOther}
              className="w-full border rounded-lg p-2 bg-slate-50"
            />
          </div>
          <div className="col-span-3">
            <input
              type="number"
              value={tOtherBefore}
              onChange={(e) => setTOtherBefore(Number(e.target.value || 0))}
              className="w-full border rounded-lg p-2"
            />
          </div>
          <div className="col-span-3">
            <input
              type="number"
              value={tOtherAfter}
              onChange={(e) => setTOtherAfter(Number(e.target.value || 0))}
              className="w-full border rounded-lg p-2"
            />
          </div>
        </div>

        <div className="flex flex-col md:flex-row md:items-center justify-between bg-slate-50 rounded-xl p-3 mt-3 text-sm">
          <div>
            入力合計（4機能）＝ <b>{sumFour}</b> 件 ／ その他＝{' '}
            <b className={nOther < 0 ? "text-amber-600" : ""}>{nOther}</b> 件 ／ 総合計＝{' '}
            <b>{sumFour + nOther}</b> 件
          </div>
          <div className={nOther < 0 ? "text-amber-600" : "text-emerald-600"}>
            {nOther < 0
              ? "合計が総数を超過しています（その他が負値）。件数配分を見直してください。"
              : "その他は自動調整されます。合計は常に総数と一致します。"}
          </div>
        </div>

        <div className="flex gap-2 mt-3">
          <button
            onClick={() => setToast("計算を更新しました（自動計算済）")}
            className="px-3 py-2 rounded-lg bg-blue-600 text-white"
          >
            効果を計算
          </button>
          <button onClick={resetAll} className="px-3 py-2 rounded-lg border">
            リセット
          </button>
        </div>
      </div>

      {/* KPI */}
      <div className="bg-white rounded-2xl shadow p-4 mb-4 grid md:grid-cols-2 gap-3">
        <KPI
          title="時間短縮（合計・月間）"
          value={`${result.hSaved.toFixed(2)} 時間`}
          note="（手作業−自動化）の合計（/60）"
        />
        <KPI
          title="人件費削減（合計・月間）"
          value={yen(result.monthlySaving)}
          note="時給 × 時間短縮"
        />
        <KPI
          title="ネット効果（月間）"
          value={yen(result.net)}
          note="人件費削減 − FX基本料金"
          positive={result.net >= 0}
        />
        <KPI
          title="ネット効果（年間）"
          value={yen(result.netYear)}
          note="ネット効果（月間）×12"
        />
      </div>

      {/* 比較＋エクスポート */}
      <div className="bg-white rounded-2xl shadow p-4 mb-4 grid md:grid-cols-2 gap-3">
        <KPI title="手作業コスト（月）" value={yen(result.costBefore)} note="総手作業時間 × 人件費単価" />
        <KPI title="自動化後コスト（月）" value={yen(result.costAfter)} note="総自動化後時間 × 人件費単価" />
        <KPI title="自計化×自動化トータルコスト（月）" value={yen(result.selfTotal)} note="自動化後コスト + FX基本料金" />
        <KPI title="記帳代行との比較（月）" value={yen(result.delta)} note="差額＝ 記帳代行 − 自計化×自動化" positive={result.delta >= 0} />
        <KPI title="記帳代行報酬（月）" value={yen(osFee)} note="比較用の入力値" />
        <KPI title="差額（年間換算）" value={yen(result.deltaYear)} note="差額（月）×12" />

        <div className="md:col-span-2 flex gap-2 mt-2">
          <button onClick={copySummary} className="px-3 py-2 rounded-lg border">
            コピー
          </button>
          <button onClick={printPage} className="px-3 py-2 rounded-lg border">
            印刷
          </button>
          <button onClick={exportCSV} className="px-3 py-2 rounded-lg border">
            CSV出力
          </button>
        </div>
      </div>

      {/* ステップバック */}
      <div className="bg-white rounded-2xl shadow p-4">
        <b>ステップバック・クエスチョン（前提の確認）</b>
        <ul className="list-disc pl-6 text-sm text-slate-600 mt-2 space-y-1">
          <li>
            人件費単価は<strong>法定福利費・賞与按分・間接時間</strong>を含む「実効時給」ですか？
          </li>
          <li>
            時間は誰の作業時間ですか？（所内/顧問先）双方の削減を分けて評価しますか？
          </li>
          <li>自動化後の残作業（例：例外仕訳、承認、チェック）は反映していますか？</li>
          <li>販売管理・給与は「件数」よりも「締め回数×担当者数」で表した方が正確な場合があります。</li>
          <li>FXシリーズ以外の追加費用（スマホで経費オプション等）がある場合、別途差し引きが必要です。</li>
        </ul>
      </div>

      {/* Toast */}
      {toast && (
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-sm px-3 py-2 rounded-lg shadow-lg">
          {toast}
        </div>
      )}

      <div className="text-xs text-slate-400 mt-3">r10（React版）— 実測値の入力を前提とする内部試算ツール</div>
    </div>
  );
}

function Field({ label, children }) {
  return (
    <label className="text-sm text-slate-600">
      <div className="mb-1 text-slate-500 text-xs">{label}</div>
      {children}
    </label>
  );
}

function Row({ label, n, setN, tb, setTb, ta, setTa }) {
  return (
    <div className="grid grid-cols-12 gap-2 items-center py-1">
      <div className="col-span-4 text-slate-700">{label}</div>
      <div className="col-span-2">
        <input
          type="number"
          value={n}
          onChange={(e) => setN(Number(e.target.value || 0))}
          className="w-full border rounded-lg p-2"
        />
      </div>
      <div className="col-span-3">
        <input
          type="number"
          value={tb}
          onChange={(e) => setTb(Number(e.target.value || 0))}
          className="w-full border rounded-lg p-2"
        />
      </div>
      <div className="col-span-3">
        <input
          type="number"
          value={ta}
          onChange={(e) => setTa(Number(e.target.value || 0))}
          className="w-full border rounded-lg p-2"
        />
      </div>
    </div>
  );
}

function KPI({ title, value, note, positive }) {
  return (
    <div className="border border-dashed rounded-xl p-4">
      <div className="text-xs text-slate-500 mb-1">{title}</div>
      <div
        className={`text-xl font-semibold ${
          positive === undefined ? "" : positive ? "text-emerald-600" : "text-amber-600"
        }`}
      >
        {value}
      </div>
      <div className="text-xs text-slate-400 mt-1">{note}</div>
    </div>
  );
}
