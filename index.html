<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TKC方式 | 自動化メリット試算（r55・5機能・一括チェック＋グラフ）</title>

  <!-- ファビコン：192×192 PNG（ファイル名：favicon192192.png） -->
  <link rel="icon" type="image/png" sizes="192x192" href="./favicon192192.png">
  <link rel="shortcut icon" href="./favicon192192.png">
  <meta name="theme-color" content="#2084A8">

  <style>
    :root{
      --bg:#eef5f9; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --accent:#2084A8; --accent-600:#1b7899; --accent-700:#166b8a;
      --ring:rgba(32,132,168,.18);
      --good:#059669; --warn:#b45309; --radius:14px;
      --cols:.9fr 1fr 2.8fr 1.0fr 1.15fr .35fr 1.15fr .8fr;
      --row-gap:6px; --col-gap:4px;
      --kpiRowH:auto;
    }
    @media (max-width:900px){ :root{ --cols:.8fr .95fr 2.6fr .95fr 1.05fr .3fr 1.05fr .75fr; } }
    @media (max-width:740px){ :root{ --cols:.75fr .9fr 2.5fr .9fr 1.0fr .28fr 1.0fr .7fr; } }

    *{box-sizing:border-box;}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;margin:0;color:var(--ink);background:var(--bg);}
    .wrap{max-width:1000px;margin:24px auto 64px;padding:0 16px;}
    header{margin-bottom:16px;}
    h1{font-size:clamp(20px,3vw,28px);margin:0 0 6px;}
    .sub{color:var(--muted);font-size:13px;line-height:1.5;}
    @media (max-width:900px){ .sub{font-size:12px;} }
    @media (max-width:932px) and (orientation:landscape){ .sub{font-size:10.5px !important; line-height:1.45;} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 2px rgba(15,23,42,.06),0 8px 24px rgba(2,6,23,.08);padding:16px;margin:12px 0;}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:start;}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px;}
    input[type="number"],input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-size:14px;outline:none;transition:border-color .15s,box-shadow .15s;}
    input[type="number"]:focus,input[type="text"]:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring);}
    input[readonly]{background:#f8fafc;color:#334155;}
    .th,.td{padding:10px 8px;}
    .thead{color:var(--muted);font-size:12px;font-weight:600;border-bottom:1px solid #e3edf4;}
    .td.res{text-align:right;font-variant-numeric:tabular-nums;}
    .note{font-size:12px;color:var(--muted);}
    .note-right{font-size:11px;color:var(--muted);text-align:right;margin-top:4px;}
    .btns{display:flex;gap:10px;flex-wrap:wrap;}
    button{cursor:pointer;border:none;border-radius:12px;padding:10px 14px;font-size:14px;transition:transform .08s ease, box-shadow .15s ease, background-color .15s ease, filter .15s ease;}
    .outline{background:#fff;border:1px solid rgba(32,132,168,.45);color:var(--accent);box-shadow:0 1px 6px rgba(2,6,23,.05);}
    .outline:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(32,132,168,.18);background:#f3f9fc;}
    .outline:active{transform:translateY(0);background:#eef7fb;}

    /* KPI */
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
    .kpi .item{background:#fff;border:1px dashed #e2e8f0;border-radius:12px;padding:8px;min-height:var(--kpiRowH);display:flex;flex-direction:column;justify-content:space-between;}
    .kpi h3{margin:0 0 4px;font-size:11.5px;color:var(--muted);}
    .kpi .val{font-size:clamp(16px,2.4vw,20px);}
    .krow{display:flex;align-items:flex-end;justify-content:space-between;gap:8px;}
    .aside{display:flex;flex-direction:column;align-items:flex-end;gap:2px;}
    .aside .label{font-size:10.5px;color:var(--muted);}
    .aside .yen{font-size:clamp(13px,2.0vw,17px);color:#0f5132;}

    /* 人件費削減カード：枠線で強調（悪目立ちなし） */
    .kpi .item.item--emph{ border:2px solid rgba(32,132,168,.9) !important; box-shadow:none; }
    .savings .val-main{font-size:clamp(21px,3.2vw,29px);font-weight:800;color:#059669;line-height:1;}

    /* 仕訳自動化率（大きめ表示） */
    .rate-hero{font-size:clamp(21px,3.2vw,29px);font-weight:800;color:var(--accent);}
    .krow .rate-hero + .aside .val{font-size:13px;}

    /* 機能別 削減時間（重要度低） */
    #kpiBreakdown.breakdown{
      font-size:10.5px; line-height:1.35;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .sumline{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;padding:10px 12px;background:#eaf2f7;border-radius:10px;font-size:13px;}
    @media (max-width:900px){ .sumline{font-size:12px;} }
    @media (max-width:932px) and (orientation:landscape){ .sumline{font-size:10.5px;} }

    .ok{color:var(--good);} .warn{color:var(--warn);}

    .compact-table .thead{margin-bottom:6px;}
    .headbar{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:8px;}
    .headnote{font-size:12px;color:var(--muted);margin-left:8px;white-space:nowrap;}
    @media (max-width:932px) and (orientation:landscape){ .headnote{font-size:11px;} }

    .features-head,.features-rows{display:grid;grid-template-columns:var(--cols);align-items:center;gap:var(--row-gap) var(--col-gap);}
    .features-rows .td,.features-head .th{padding:6px 6px;min-width:0;}
    .features-rows .c-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .features-rows .td.arrow,.features-head .th.arrow{text-align:center;color:#64748b;}
    .features-head .th:last-child,.features-rows .td.res{text-align:right;}
    .compact-table input[type="number"],.compact-table input[type="text"]{padding:6px 8px;font-size:13px;border-radius:8px;}

    .features-head .th.kind, .features-rows .td.kind{padding-left:2px;margin-left:-2px;}

    .feat-link{color:var(--accent); text-decoration:underline; text-underline-offset:2px;}
    .feat-link:hover{color:var(--accent-600);}

    .comp-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .seg{display:flex;gap:6px;}
    .seg.sm .segbtn{padding:6px 10px;font-size:12px;border-radius:10px;}
    .segbtn{flex:0 0 auto;background:#fff;border:1px solid rgba(32,132,168,.45);color:var(--accent);padding:10px 14px;border-radius:12px;cursor:pointer;font-size:14px;transition:.15s;}
    .segbtn:hover{background:#f3f9fc;box-shadow:0 4px 12px rgba(32,132,168,.12);}
    .segbtn.active{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 4px 14px rgba(32,132,168,.25);}
    .comp-row input[type="text"]{flex:1 1 280px;min-width:180px;}
    .calc-note{margin-top:6px;color:var(--muted);font-size:12px;}
    .hourly-badge{margin-top:6px;font-weight:700;}

    .adopt-box{display:flex;align-items:center;justify-content:center;width:24px;margin:0 auto;}
    .adopt-dash{display:inline-block;width:24px;text-align:center;color:#94a3b8;}

    /* 一括チェック */
    .features-head .th.bulk{ text-align:center; }
    .bulk-label{display:flex; align-items:center; justify-content:center; gap:6px; color:var(--muted); font-size:12px; user-select:none;}
    .bulk-label input{ transform:scale(1.1); }

    /* グラフ */
    .chart-head{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:8px;}
    .chart-title{font-weight:800;color:var(--accent);font-size:clamp(16px,2.6vw,20px);}
    .chart-sub{color:var(--muted);font-size:12px;}
    .chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
    .chartbox{background:#fff;border:1px dashed #e2e8f0;border-radius:12px;padding:10px;}
    .chartbox h4{margin:0 0 8px;font-size:12px;color:var(--muted);}
    canvas{width:100%;height:220px;display:block;}
    @media (max-width:720px){ .chart-grid{grid-template-columns:1fr;} canvas{height:200px;} }

    .credit{margin:28px 0 0;text-align:center;color:#475569;font-size:12px;}
    .credit small{opacity:.9;}

    @media (max-width:720px){
      .kpi{grid-template-columns:1fr;}
      .thead{display:none;}
    }
    @media print{
      .btns,#copyBtn,#csvBtn,#printBtn,#footerBtns{display:none!important;}
      body{background:#fff;}
      .card{box-shadow:none;border:1px solid #e5e7eb;}
      .credit{display:none;}
    }
  </style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <h1>自動化メリット試算（TKC方式・5機能）</h1>
    <div class="sub">5機能のチェックで<strong>導入（自動化後）/未導入（手作業）</strong>を切替。導入効果（時間・人件費）を算出します。月間仕訳総数との差分は<strong>「その他」</strong>として自動調整。</div>
  </header>

  <!-- 試算前提 -->
  <section class="card">
    <div class="grid" style="grid-template-columns:repeat(12,1fr);">
      <div class="thead th" style="grid-column:span 12;">試算前提</div>

      <div class="td field" style="grid-column:span 6;">
        <label>給与の単位を選択して入力（社保等<strong>事業主負担16%</strong>は換算時に自動加算）</label>
        <div class="comp-row">
          <div class="seg sm" role="tablist" aria-label="給与単位">
            <button type="button" class="segbtn" data-unit="hour"  onclick="setUnit('hour')">時給</button>
            <button type="button" class="segbtn" data-unit="month" onclick="setUnit('month')">月給</button>
            <button type="button" class="segbtn active" data-unit="year" onclick="setUnit('year')">年収</button>
          </div>
          <input id="baseComp" type="text" inputmode="numeric" value="4,600,000"
                 oninput="formatLive(this); updateWage()" />
        </div>
        <div class="calc-note">※初期値：令和5年民間給与実態統計調査の平均年収<strong>460万円</strong>をベースに算出。換算は<strong>月160時間×12ヶ月</strong>、<strong>事業主負担16％</strong>を自動加算して時給化。</div>
        <div class="hourly-badge">換算結果：<span id="hourlyDisplay">¥2,780 / 時</span>（16％込み）</div>
        <input type="hidden" id="wage" value="2780" />
      </div>

      <div class="td field" style="grid-column:span 6;">
        <label>月間仕訳数（<span class="note">総数</span>）</label>
        <input id="totalJournals" type="number" inputmode="numeric" value="320" min="0" oninput="calc()" />
      </div>
    </div>
  </section>

  <!-- 機能別（チェックで導入状態切替） -->
  <section class="card compact-table">
    <div class="headbar">
      <div class="thead">機能別（チェックで導入状態を切替）</div>
      <div class="headnote">※各数値は社内の実測値を入れてください。</div>
    </div>

    <div class="features-head">
      <!-- 導入 → 一括チェック -->
      <div class="th bulk">
        <label class="bulk-label" title="5機能の導入チェックを一括でON/OFF">
          <span>一括</span>
          <input id="cb_all" type="checkbox" onclick="toggleAll(this.checked)" />
        </label>
      </div>
      <div class="th kind">取引種類</div>
      <div class="th c-name">機能</div>
      <div class="th">件数/月</div>
      <div class="th">手作業 分/件</div>
      <div class="th arrow"></div>
      <div class="th">自動化 分/件</div>
      <div class="th">削減h</div>
    </div>

    <div class="features-rows">
      <!-- 証憑 -->
      <div class="td"><div class="adopt-box"><input class="feat-cb" id="cb_receipts" type="checkbox" checked onchange="calc()" /></div></div>
      <div class="td kind">現金</div>
      <div class="td c-name">
        <a class="feat-link" href="https://www.matsumoto-kaikei.or.jp/tkc-tds" target="_blank" rel="noopener">証憑保存機能（スマホで経費）</a>
      </div>
      <div class="td"><input id="n_receipts" type="number" value="30" min="0" oninput="calc()" /></div>
      <div class="td"><input id="tb_receipts" type="number" value="3" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td arrow">▷</div>
      <div class="td"><input id="ta_receipts" type="number" value="2" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td res" id="sv_receipts">0.00</div>

      <!-- 銀行信販 -->
      <div class="td"><div class="adopt-box"><input class="feat-cb" id="cb_bank" type="checkbox" checked onchange="calc()" /></div></div>
      <div class="td kind">預金・カード</div>
      <div class="td c-name">
        <a class="feat-link" href="https://www.matsumoto-kaikei.or.jp/tkc-FinTech" target="_blank" rel="noopener">銀行信販データ受信機能</a>
      </div>
      <div class="td"><input id="n_bank" type="number" value="260" min="0" oninput="calc()" /></div>
      <div class="td"><input id="tb_bank" type="number" value="2" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td arrow">▷</div>
      <div class="td"><input id="ta_bank" type="number" value="0.5" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td res" id="sv_bank">0.00</div>

      <!-- 給与 -->
      <div class="td"><div class="adopt-box"><input class="feat-cb" id="cb_payroll" type="checkbox" checked onchange="calc()" /></div></div>
      <div class="td kind">給与</div>
      <div class="td c-name">
        <a class="feat-link" href="https://www.matsumoto-kaikei.or.jp/tkc-system012" target="_blank" rel="noopener">給与計算機能（仕訳含む）</a>
      </div>
      <div class="td"><input id="n_payroll" type="number" value="10" min="0" oninput="calc()" /></div>
      <div class="td"><input id="tb_payroll" type="number" value="8" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td arrow">▷</div>
      <div class="td"><input id="ta_payroll" type="number" value="3" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td res" id="sv_payroll">0.00</div>

      <!-- 販売管理 -->
      <div class="td"><div class="adopt-box"><input class="feat-cb" id="cb_sales" type="checkbox" checked onchange="calc()" /></div></div>
      <div class="td kind">売上</div>
      <div class="td c-name">
        <a class="feat-link" href="https://www.tkc.jp/file.jsp?id=166750" target="_blank" rel="noopener">販売管理機能（売上計上・請求）</a>
      </div>
      <div class="td"><input id="n_sales" type="number" value="12" min="0" oninput="calc()" /></div>
      <div class="td"><input id="tb_sales" type="number" value="10" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td arrow">▷</div>
      <div class="td"><input id="ta_sales" type="number" value="5" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td res" id="sv_sales">0.00</div>

      <!-- レジ -->
      <div class="td"><div class="adopt-box"><input class="feat-cb" id="cb_pos" type="checkbox" checked onchange="calc()" /></div></div>
      <div class="td kind">レジ</div>
      <div class="td c-name">
        <a class="feat-link" href="https://www.tkc.jp/fx/#:~:text=%E3%81%97%E3%81%8F%E3%81%AF%E3%81%93%E3%81%A1%E3%82%89-,%E5%A3%B2%E4%B8%8A%E4%BB%95%E8%A8%B3%E3%81%AE%E5%85%A5%E5%8A%9B%E6%A5%AD%E5%8B%99%E3%82%92%E5%A4%A7%E5%B9%85%E3%81%AB%E7%9C%81%E5%8A%9B%E5%8C%96,-%E3%82%BF%E3%83%96%E3%83%AC%E3%83%83%E3%83%88POS%E3%83%AC%E3%82%B8" target="_blank" rel="noopener">レジからのデータ受信</a>
      </div>
      <div class="td"><input id="n_pos" type="number" value="0" min="0" oninput="calc()" /></div>
      <div class="td"><input id="tb_pos" type="number" value="3" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td arrow">▷</div>
      <div class="td"><input id="ta_pos" type="number" value="0.5" min="0" step="0.1" oninput="calc()" /></div>
      <div class="td res" id="sv_pos">0.00</div>

      <!-- その他 -->
      <div class="td"><div class="adopt-box"><span class="adopt-dash">—</span></div></div>
      <div class="td kind">その他</div>
      <div class="td c-name">その他（自動調整・対象外）</div>
      <div class="td"><input id="n_other" type="number" value="0" readonly /></div>
      <div class="td"><input id="tb_other" type="number" value="3" min="0" step="0.1" oninput="syncOther(); calc()" /></div>
      <div class="td arrow">▷</div>
      <div class="td"><input id="ta_other" type="number" value="3" min="0" step="0.1" readonly /></div>
      <div class="td res" id="sv_other">0.00</div>
    </div>

    <div class="sumline">
      <div>入力合計（5機能）＝ <strong id="sumFeat">312</strong> 件 ／ その他＝ <strong id="sumOther">8</strong> 件 ／ 総合計＝ <strong id="sumTotal">320</strong> 件</div>
      <div id="deltaMsg" class="ok">その他は自動調整されます。合計は常に総数と一致します。</div>
    </div>

    <div class="btns" style="margin-top:8px;">
      <!-- 効果を計算：削除済み。自動再計算 -->
      <button class="outline" onclick="resetAll(); calc();">リセット</button>
    </div>
  </section>

  <!-- 削減率（グラフを先に表示） -->
  <section class="card">
    <div class="chart-head">
      <div class="chart-title">削減率 <span id="chartRate">0.00%</span></div>
      <div class="chart-sub">Before → After 可視化</div>
    </div>
    <div class="chart-grid">
      <div class="chartbox">
        <h4>総時間（時間）</h4>
        <canvas id="chartTime" width="600" height="300"></canvas>
      </div>
      <div class="chartbox">
        <h4>人件費（円）</h4>
        <canvas id="chartCost" width="600" height="300"></canvas>
      </div>
    </div>
  </section>

  <!-- 結果（クラスタを後に表示） -->
  <section class="card">
    <div class="kpi">
      <div class="item">
        <h3>仕訳自動化率</h3>
        <div class="krow">
          <div class="rate-hero" id="kpiRate">0.00%</div>
          <div class="aside">
            <div class="label">導入機能数</div>
            <div class="val" id="kpiAdopt">0 / 5</div>
            <div class="note-right">チェックあり＆件数>0を採用としてカウント</div>
          </div>
        </div>
      </div>

      <div class="item" id="kpiBefore"><h3>導入なし 総時間（月）</h3><div class="krow"><div class="val" id="kpiHBefore">0.00 時間</div><div class="aside"><div class="label">人件費相当額</div><div class="yen" id="kpiCostBefore">¥0</div></div></div></div>
      <div class="item" id="kpiAfter"><h3>導入あり 総時間（月）</h3><div class="krow"><div class="val" id="kpiHAfter">0.00 時間</div><div class="aside"><div class="label">人件費相当額</div><div class="yen" id="kpiCostAfter">¥0</div></div></div></div>
      <div class="item"><h3>時間短縮（合計・月間）</h3><div class="val" id="kpiSaved">0.00 時間</div><div class="note">（導入なし − 導入あり）</div></div>

      <div class="item item--emph savings">
        <h3>人件費削減</h3>
        <div class="krow">
          <div class="val-main" id="kpiYen">¥0</div>
          <div class="aside"><div class="label">年間（12ヶ月換算）</div><div class="yen" id="kpiYenYear">¥0</div></div>
        </div>
      </div>

      <div class="item"><h3>機能別 削減時間（h）</h3><div class="note">チェック時のみ削減 > 0</div><div class="val breakdown" id="kpiBreakdown">—</div></div>
    </div>
  </section>

  <!-- 最下部ボタン -->
  <div class="btns" id="footerBtns" style="justify-content:center; margin-top:8px;">
    <button class="outline" id="copyBtn" onclick="copySummary()">コピー</button>
    <button class="outline" id="csvBtn"  onclick="exportCSV()">CSV出力</button>
    <button class="outline" id="printBtn" onclick="printPage()">印刷</button>
  </div>

  <div class="credit" style="text-align:center;color:#475569;font-size:12px;margin-top:28px">
    <small>Copyright (c) <span id="creditYear"></span> <span id="creditCompany">税理士法人松本会計事務所</span> All Rights Reserved. / <span id="creditRev">r55</span></small>
  </div>

  <div id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:.25s;z-index:9999;font-size:13px;"></div>
</div>

<script>
  /* ========= ユーティリティ ========= */
  const $ = (id)=>document.getElementById(id);
  const safeFixed = (n,d=2)=> (Number.isFinite(n)? n.toFixed(d) : (0).toFixed(d));
  const yen = (n)=> Number.isFinite(n) ? n.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}) : '¥0';

  function parseNum(v){ if(v==null) return 0; const s=String(v).replace(/[,\s]/g,''); const n=parseFloat(s); return isNaN(n)?0:n; }
  const num = (id)=> parseNum($(id).value);
  function formatLive(el){ const raw=(el.value||'').replace(/[^\d]/g,''); el.value = raw? Number(raw).toLocaleString('ja-JP'):''; }

  (function(){ const y=new Date().getFullYear(); $('creditYear').textContent=y; })();

  function toast(m){ const t=$('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,1600); }

  function syncOther(){ $('ta_other').value = $('tb_other').value; }
  function recalcOther(){
    const total = num('totalJournals');
    const sumFeat = num('n_receipts') + num('n_bank') + num('n_payroll') + num('n_sales') + num('n_pos');
    const other = total - sumFeat;
    $('n_other').value = other;
    $('sumFeat').textContent  = String(sumFeat);
    $('sumOther').textContent = String(other);
    $('sumTotal').textContent = String(sumFeat + other);
    const m = $('deltaMsg');
    if(other < 0){
      m.textContent = '合計が総数を超過しています（その他が負値）。件数配分を見直してください。';
      m.className = 'warn';
    }else{
      m.textContent = 'その他は自動調整されます。合計は常に総数と一致します。';
      m.className = 'ok';
    }
  }

  const HOURS_PER_MONTH = 160;
  let payUnit = 'year';
  function setUnit(u){
    payUnit = u;
    document.querySelectorAll('.segbtn').forEach(b=>{
      const on = (b.dataset.unit===u);
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on?'true':'false');
    });
    const base = $('baseComp');
    if(u==='hour'){ base.value='2,500'; }
    if(u==='month'){ base.value='300,000'; }
    if(u==='year'){ base.value='4,600,000'; }
    formatLive(base);
    updateWage();
  }
  function updateWage(){
    const v = parseNum($('baseComp').value);
    let hourly = 0;
    if(payUnit==='hour'){ hourly = v; }
    else if(payUnit==='month'){ hourly = v / HOURS_PER_MONTH; }
    else { hourly = v / 12 / HOURS_PER_MONTH; }
    hourly = hourly * 1.16; // 事業主負担16%込み
    $('hourlyDisplay').textContent = yen(Math.round(hourly)) + ' / 時';
    $('wage').value = Math.round(hourly);
    calc();
  }

  function mod(label, checked, n, tb, ta, wage){
    const cnt = Math.max(0, n);
    const hBefore = (tb * cnt) / 60;
    const hAfter  = (ta * cnt) / 60;
    const hChosen = checked ? hAfter : hBefore;
    const hSaved  = Math.max(0, hBefore - hChosen);
    const adopted = !!checked && cnt > 0;
    return { label, checked, cnt, tb, ta, hBefore, hAfter, hChosen, hSaved, adopted,
             cBefore:hBefore*wage, cChosen:hChosen*wage };
  }

  function compute(){
    const wage = parseFloat($('wage').value) || 0;
    const m_receipts = mod('証憑保存機能（スマホで経費）', $('cb_receipts').checked, num('n_receipts'), num('tb_receipts'), num('ta_receipts'), wage);
    const m_bank     = mod('銀行信販データ受信機能',         $('cb_bank').checked,     num('n_bank'),     num('tb_bank'),     num('ta_bank'),     wage);
    const m_payroll  = mod('給与計算機能（仕訳含む）',       $('cb_payroll').checked,  num('n_payroll'),  num('tb_payroll'),  num('ta_payroll'),  wage);
    const m_sales    = mod('販売管理機能（売上計上・請求）', $('cb_sales').checked,    num('n_sales'),    num('tb_sales'),    num('ta_sales'),    wage);
    const m_pos      = mod('レジからのデータ受信',           $('cb_pos').checked,      num('n_pos'),      num('tb_pos'),      num('ta_pos'),      wage);

    const hOther = (num('tb_other') * Math.max(0, num('n_other'))) / 60;
    const mods = [m_receipts, m_bank, m_payroll, m_sales, m_pos];

    const hBefore = mods.reduce((s,m)=>s+m.hBefore,0) + hOther;
    const hChosen = mods.reduce((s,m)=>s+m.hChosen,0) + hOther;
    const hSaved  = Math.max(0, hBefore - hChosen);

    const costBefore = hBefore * wage;
    const costChosen = hChosen * wage;
    const monthlySaving = costBefore - costChosen;

    const adopted = mods.reduce((s,m)=> s + (m.adopted?1:0), 0);
    const totalJ = num('totalJournals');
    const autoJ  = mods.reduce((s,m)=> s + (m.checked ? m.cnt : 0), 0);
    const rateJ  = totalJ > 0 ? (autoJ / totalJ) * 100 : 0;

    return { wage, mods, hOther, hBefore, hChosen, hSaved,
             costBefore, costChosen, monthlySaving,
             adopted, autoJ, totalJ, rateJ };
  }

  function syncKPIHeights(){
    const beforeEl = $('kpiBefore');
    const afterEl  = $('kpiAfter');
    if(!beforeEl || !afterEl) return;
    const h = Math.max(beforeEl.offsetHeight, afterEl.offsetHeight);
    document.documentElement.style.setProperty('--kpiRowH', h+'px');
  }

  function updateUI(r){
    $('sv_receipts').textContent = safeFixed(r.mods[0].hSaved);
    $('sv_bank').textContent     = safeFixed(r.mods[1].hSaved);
    $('sv_payroll').textContent  = safeFixed(r.mods[2].hSaved);
    $('sv_sales').textContent    = safeFixed(r.mods[3].hSaved);
    $('sv_pos').textContent      = safeFixed(r.mods[4].hSaved);
    $('sv_other').textContent    = '0.00';

    $('kpiHBefore').textContent = safeFixed(r.hBefore) + ' 時間';
    $('kpiHAfter').textContent  = safeFixed(r.hChosen) + ' 時間';
    $('kpiSaved').textContent   = safeFixed(r.hSaved)  + ' 時間';
    $('kpiCostBefore').textContent = yen(r.costBefore);
    $('kpiCostAfter').textContent  = yen(r.costChosen);
    $('kpiYen').textContent        = yen(r.monthlySaving);
    $('kpiYenYear').textContent    = yen(r.monthlySaving * 12);

    $('kpiRate').textContent  = (Number.isFinite(r.rateJ)? r.rateJ.toFixed(2):'0.00') + '%';
    $('kpiAdopt').textContent = r.adopted + ' / 5';

    const full = r.mods.map(m=> m.label+':'+safeFixed(m.hSaved)+'h').join(' / ') || '—';
    const bd = $('kpiBreakdown'); bd.textContent = full; bd.title = full;

    drawChartsAnimated(r); // グラフ（アニメ付）
    syncKPIHeights();
    refreshBulkCheckbox();
  }

  /* ===== 一括チェック制御 ===== */
  function toggleAll(checked){
    document.querySelectorAll('.feat-cb').forEach(cb => cb.checked = checked);
    calc();
  }
  function refreshBulkCheckbox(){
    const boxes = Array.from(document.querySelectorAll('.feat-cb'));
    const all = $('cb_all'); if(!all) return;
    const total = boxes.length;
    const cnt = boxes.filter(b=>b.checked).length;
    all.indeterminate = (cnt>0 && cnt<total);
    all.checked = (cnt===total);
  }

  /* ========== グラフ描画・アニメーション ========== */
  function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2; }
  function lerp(a,b,t){ return a + (b-a)*t; }
  const chartState = { init:false, time:{before:0, after:0}, cost:{before:0, after:0}, rate:0, animId:null };

  function drawBar(canvasId, beforeVal, afterVal, formatter, topLabel){
    const c = $(canvasId);
    if(!c) return;
    const ctx = c.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const cssW = c.clientWidth, cssH = c.clientHeight;
    c.width = Math.round(cssW * dpr); c.height = Math.round(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const pad = 28, barW = 44, gap = 58;
    ctx.clearRect(0,0,cssW,cssH);
    ctx.font = '12px system-ui, -apple-system, "Segoe UI", Roboto';
    ctx.fillStyle = '#64748b';

    const max = Math.max(beforeVal, afterVal, 1);
    const chartH = cssH - pad*2;
    const baseY = cssH - pad;

    // grid
    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;
    for(let i=0;i<=4;i++){
      const y = baseY - chartH*(i/4);
      ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(cssW-pad,y); ctx.stroke();
    }

    const x0 = cssW/2 - gap/2 - barW; // before
    const x1 = cssW/2 + gap/2;        // after
    const h0 = chartH * (beforeVal/max);
    const h1 = chartH * (afterVal/max);

    // before
    ctx.fillStyle = '#cbd5e1';
    ctx.fillRect(x0, baseY - h0, barW, h0);
    // after
    ctx.fillStyle = '#2084A8';
    ctx.fillRect(x1, baseY - h1, barW, h1);

    // labels
    ctx.fillStyle = '#334155';
    ctx.textAlign = 'center';
    ctx.fillText('導入なし', x0 + barW/2, baseY + 16);
    ctx.fillText('導入あり', x1 + barW/2, baseY + 16);

    // values
    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 13px system-ui, -apple-system';
    ctx.fillText(formatter(beforeVal), x0 + barW/2, baseY - h0 - 6);
    ctx.fillText(formatter(afterVal),  x1 + barW/2, baseY - h1 - 6);

    // 右上：トップラベル
    ctx.textAlign = 'right';
    ctx.font = 'bold 14px system-ui, -apple-system';
    ctx.fillStyle = '#166b8a';
    ctx.fillText(topLabel, cssW - pad, pad + 2);
  }

  function drawChartsOnce(res){
    const rate = res.hBefore > 0 ? (res.hBefore - res.hChosen) / res.hBefore * 100 : 0;
    const rateStr = (Number.isFinite(rate)? rate.toFixed(2):'0.00') + '%';
    const rateEl = $('chartRate'); if(rateEl) rateEl.textContent = rateStr;

    drawBar('chartTime', res.hBefore, res.hChosen, v=>`${safeFixed(v,2)}h`, `時間短縮 ${safeFixed(res.hSaved,2)}h`);
    drawBar('chartCost', res.costBefore, res.costChosen, v=>yen(v), `人件費削減 ${yen(res.monthlySaving)}`);
  }

  function drawChartsAnimated(res){
    const next = {
      time:{ before: Math.max(0,res.hBefore), after: Math.max(0,res.hChosen) },
      cost:{ before: Math.max(0,res.costBefore), after: Math.max(0,res.costChosen) },
      rate: (res.hBefore>0? (res.hBefore-res.hChosen)/res.hBefore*100 : 0)
    };

    if(!chartState.init){
      chartState.time = {...next.time};
      chartState.cost = {...next.cost};
      chartState.rate = next.rate;
      chartState.init = true;
      drawChartsOnce(res);
      return;
    }

    const prev = {
      time:{...chartState.time},
      cost:{...chartState.cost},
      rate: chartState.rate
    };

    if(chartState.animId){ cancelAnimationFrame(chartState.animId); chartState.animId = null; }

    const dur = 500; // ms
    const t0 = performance.now();

    const step = (now)=>{
      const t = Math.min(1, (now - t0) / dur);
      const e = easeInOutCubic(t);

      const timeB = prev.time.before + (next.time.before - prev.time.before) * e;
      const timeA = prev.time.after  + (next.time.after  - prev.time.after ) * e;
      const costB = prev.cost.before + (next.cost.before - prev.cost.before) * e;
      const costA = prev.cost.after  + (next.cost.after  - prev.cost.after ) * e;
      const rate  = prev.rate + (next.rate - prev.rate) * e;

      const rateEl = $('chartRate'); if(rateEl) rateEl.textContent = (Number.isFinite(rate)? rate.toFixed(2):'0.00') + '%';

      const timeSaved = Math.max(0, timeB - timeA);
      const costSaved = Math.max(0, costB - costA);

      drawBar('chartTime', timeB, timeA, v=>`${safeFixed(v,2)}h`, `時間短縮 ${safeFixed(timeSaved,2)}h`);
      drawBar('chartCost', costB, costA, v=>yen(v), `人件費削減 ${yen(costSaved)}`);

      if(t < 1){
        chartState.animId = requestAnimationFrame(step);
      }else{
        chartState.time = {...next.time};
        chartState.cost = {...next.cost};
        chartState.rate = next.rate;
        chartState.animId = null;
      }
    };

    chartState.animId = requestAnimationFrame(step);
  }

  async function copySummary(){
    const r = compute();
    const lines = [];
    lines.push('【自動化メリット試算サマリー（5機能）】');
    lines.push('時給(社保16%込み): ' + Math.round(r.wage) + ' 円/時');
    lines.push('仕訳自動化率: ' + (Number.isFinite(r.rateJ)? r.rateJ.toFixed(2):'0.00') + '%（導入機能: ' + r.adopted + ' / 5）');
    r.mods.forEach(m=>{
      lines.push(m.label+' ['+(m.adopted?'導入':'未導入')+'] 件数='+m.cnt+' 手作業='+m.tb+'分 自動化='+m.ta+'分 削減='+safeFixed(m.hSaved)+'h');
    });
    lines.push('— 合計');
    lines.push('導入なし 総時間: ' + safeFixed(r.hBefore) + 'h（人件費相当額: ' + Math.round(r.costBefore) + '円）');
    lines.push('導入あり 総時間: ' + safeFixed(r.hChosen) + 'h（人件費相当額: ' + Math.round(r.costChosen) + '円）');
    lines.push('時間短縮(月): ' + safeFixed(r.hSaved) + 'h');
    lines.push('人件費削減(月): ' + Math.round(r.monthlySaving) + ' 円');
    lines.push('人件費削減(年): ' + Math.round(r.monthlySaving*12) + ' 円');

    const text = lines.join('\n');
    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
      else{
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.focus(); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
      }
      toast('コピーしました');
    }catch(e){ toast('コピーに失敗しました'); }
  }

  function exportCSV(){
    const r=compute();
    const rows=[];
    rows.push(['項目','導入','件数','手作業(分/件)','自動化(分/件)','導入あり時間(h)','導入なし時間(h)','削減時間(h)']);
    r.mods.forEach(m=>{
      rows.push([m.label,(m.adopted?'導入':'未導入'),m.cnt,m.tb,m.ta,safeFixed(m.hChosen),safeFixed(m.hBefore),safeFixed(m.hSaved)]);
    });
    rows.push([]);
    rows.push(['時給(社保16%込み)', Math.round(r.wage)]);
    rows.push(['仕訳自動化率', (Number.isFinite(r.rateJ)? r.rateJ.toFixed(2):'0.00')+'%']);
    rows.push(['導入機能数', r.adopted + ' / 5']);
    rows.push(['導入なし 人件費相当額(円)',Math.round(r.costBefore)]);
    rows.push(['導入あり 人件費相当額(円)',Math.round(r.costChosen)]);
    rows.push(['時間短縮(h/月)',safeFixed(r.hSaved)]);
    rows.push(['人件費削減(円/月)',Math.round(r.monthlySaving)]);
    rows.push(['人件費削減(円/年)',Math.round(r.monthlySaving*12)]);

    const csv = rows.map(cols=>cols.map(v=>{
      v=(v??'').toString().replace(/"/g,'""');
      return /[",\n\r]/.test(v)?`"${v}"`:v;
    }).join(',')).join('\r\n');

    // 文字化け防止のBOM付きUTF-8
    const bom = new Uint8Array([0xEF,0xBB,0xBF]);
    const blob = new Blob([bom,csv],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    const n=new Date(),p=x=>String(x).padStart(2,'0');
    a.href=URL.createObjectURL(blob);
    a.download=`tkc_auto_benefit_${n.getFullYear()}${p(n.getMonth()+1)}${p(n.getDate())}_${p(n.getHours())}${p(n.getMinutes())}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    toast('CSVを作成しました（UTF-8 BOM付）');
  }

  function printPage(){ try{ window.print(); }catch(e){} }

  function resetAll(){
    setUnit('year');
    $('totalJournals').value = 320;

    $('cb_receipts').checked = true;
    $('cb_bank').checked     = true;
    $('cb_payroll').checked  = true;
    $('cb_sales').checked    = true;
    $('cb_pos').checked      = true;

    $('n_receipts').value=30; $('tb_receipts').value=3;   $('ta_receipts').value=2;
    $('n_bank').value=260;    $('tb_bank').value=2;       $('ta_bank').value=0.5;
    $('n_payroll').value=10;  $('tb_payroll').value=8;    $('ta_payroll').value=3;
    $('n_sales').value=12;    $('tb_sales').value=10;     $('ta_sales').value=5;
    $('n_pos').value=0;       $('tb_pos').value=3;        $('ta_pos').value=0.5;

    $('tb_other').value=3;    $('ta_other').value=3;

    ['sv_receipts','sv_bank','sv_payroll','sv_sales','sv_pos','sv_other'].forEach(id=>$(id).textContent='0.00');

    const bc=$('baseComp'); bc.value='4,600,000'; formatLive(bc); updateWage();

    setTimeout(()=>{ refreshBulkCheckbox(); syncKPIHeights(); }, 0);
  }

  function calc(){ syncOther(); recalcOther(); const r=compute(); updateUI(r); }

  window.addEventListener('DOMContentLoaded', ()=>{ resetAll(); calc(); });
  window.addEventListener('resize', ()=>{ const r=compute(); drawChartsOnce(r); setTimeout(syncKPIHeights,0); });
</script>
</body>
</html>
